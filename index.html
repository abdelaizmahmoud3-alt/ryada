<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام الصيانة الذكي - جامعة الريادة</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* ==================== Core Styling ==================== */
        :root {
            --primary: #0056b3;        
            --primary-dark: #003d80;   
            --dark: #f8fafc;            
            --surface: #ffffff;        
            --surface-light: #f1f5f9;  
            --border: #e2e8f0;          
            --text: #1e293b;            
            --text-muted: #64748b;      
            --gold: #d97706;            
            --success: #10b981;        
            --error: #ef4444;            
            --warning: #f59e0b;        
            --info: #0ea5e9;            
            --bg-image: url('https://a.top4top.io/p_36115ao3o1.jpg');
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --sidebar-width: 260px;
        }
        
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Cairo', sans-serif; 
            background-color: var(--dark); 
            color: var(--text); 
            margin: 0; 
            min-height: 100vh;
            background-image: linear-gradient(rgba(248,250,252,0.8), rgba(248,250,252,0.8)), var(--bg-image);
            background-size: cover; 
            background-attachment: fixed;
            overflow-x: hidden;
        }

        .hidden { display: none !important; }
        html { scroll-behavior: smooth; }

        /* Loader */
        #loader {
            position: fixed; inset: 0; background: var(--dark); z-index: 99999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* --- Mobile First Layout (Default) --- */
        .app-wrapper { 
            max-width: 600px; margin: 0 auto; min-height: 100vh; 
            padding-bottom: 90px; position: relative; transition: 0.3s;
        }

        .desktop-sidebar { display: none; } /* Hidden on Mobile */

        /* Header */
        .main-banner {
            height: 200px; 
            background: linear-gradient(to bottom, rgba(0,86,179,0.6), rgba(0, 61, 128, 0.9)), var(--bg-image);
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; justify-content: flex-end; padding: 25px;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; 
            margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,86,179,0.2);
            position: relative;
        }

        .header-top { position: absolute; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center; }
        .bell-btn { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; cursor: pointer; position: relative; }
        .bell-badge { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: var(--error); border-radius: 50%; display: none; }
        
        .user-minimal h1 { margin: 0; font-size: 24px; color: #fff; font-weight: 800; }
        .user-minimal .role-badge { background: rgba(255,255,255,0.2); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; }
        .user-avatar-container img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.5); object-fit: cover; background: #fff; }

        /* Cards */
        .glass-card { background: rgba(255,255,255,0.95); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin: 15px; box-shadow: var(--shadow); }
        .request-card { cursor: pointer; border-right: 4px solid transparent; }
        .req-new { border-left: 3px solid var(--info); }
        .req-done { border-left: 3px solid var(--success); background: #f0fdf4; }
        
        /* Inputs */
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; font-weight: 700; color: var(--text-muted); margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 14px; background: var(--surface-light); border: 1px solid var(--border); border-radius: 12px; font-family: 'Cairo'; font-size: 14px; }
        
        /* Buttons */
        .btn-main { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; font-family: 'Cairo'; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 8px 15px; border-radius: 10px; cursor: pointer; font-family: 'Cairo'; }
        .btn-danger { background: var(--error); }
        .btn-sm { padding: 5px 15px; font-size: 12px; width: auto; min-height: 30px; }

        /* Nav & Tabs */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 600px; background: #fff; display: flex; justify-content: space-between; padding: 10px 20px 25px; border-top: 1px solid var(--border); z-index: 900; border-radius: 30px 30px 0 0; }
        .nav-item { text-align: center; color: var(--text-muted); font-size: 10px; cursor: pointer; width: 50px; }
        .nav-item.active { color: var(--primary); }
        .nav-add-btn { width: 55px; height: 55px; background: var(--primary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; transform: translateY(-25px); border: 4px solid var(--dark); box-shadow: 0 10px 20px rgba(0,86,179,0.3); }

        .tabs-container { display: flex; margin: 15px; background: #fff; padding: 5px; border-radius: 15px; border: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; cursor: pointer; border-radius: 10px; font-family: 'Cairo'; font-weight: 600; color: var(--text-muted); }
        .tab-btn.active { background: var(--primary); color: white; }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { background: #fff; width: 100%; max-width: 450px; padding: 25px; border-radius: 20px; max-height: 85vh; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; top: 15px; left: 15px; background: #f1f5f9; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* Misc */
        .status-pill { padding: 4px 10px; border-radius: 15px; font-size: 10px; font-weight: 700; }
        .st-pending { background: #e0f2fe; color: var(--info); }
        .st-done { background: #f0fdf4; color: var(--success); }
        .st-rejected { background: #fef2f2; color: var(--error); }
        
        .media-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .media-item { aspect-ratio: 1; background: #f1f5f9; border-radius: 10px; overflow: hidden; position: relative; }
        .media-item img, .media-item video { width: 100%; height: 100%; object-fit: cover; }

        /* Auth Screen */
        #auth-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        #auth-screen .glass-card { width: 100%; max-width: 400px; text-align: center; }
        .auth-card { padding: 10px; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; text-align: center; }
        .auth-card-input:checked + .auth-card { border-color: var(--primary); background: #eff6ff; }
        .auth-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }

        /* ==================== DESKTOP RESPONSIVE (MEDIA QUERY) ==================== */
        @media (min-width: 992px) {
            body { overflow: hidden; background: #f1f5f9; } /* Disable body scroll on PC */
            
            /* Wrapper becomes Grid */
            .app-wrapper {
                max-width: 100%;
                margin: 0;
                padding-bottom: 0;
                display: grid;
                grid-template-columns: var(--sidebar-width) 1fr; /* Sidebar | Content */
                height: 100vh;
            }

            /* Show Desktop Sidebar */
            .desktop-sidebar {
                display: flex;
                flex-direction: column;
                background: #fff;
                border-left: 1px solid var(--border);
                padding: 25px;
                height: 100vh;
                overflow-y: auto;
                box-shadow: 5px 0 15px rgba(0,0,0,0.02);
            }

            /* Sidebar Styling */
            .sidebar-logo { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
            .sidebar-logo img { width: 60px; border-radius: 12px; margin-bottom: 10px; }
            .sidebar-menu { display: flex; flex-direction: column; gap: 8px; flex: 1; }
            .sidebar-item { padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: var(--text-muted); font-weight: 600; transition: 0.2s; }
            .sidebar-item:hover { background: var(--surface-light); color: var(--primary); }
            .sidebar-item.active { background: #eff6ff; color: var(--primary); border-right: 3px solid var(--primary); }
            .sidebar-user { margin-top: auto; padding: 15px; background: var(--surface-light); border-radius: 12px; display: flex; align-items: center; gap: 10px; cursor: pointer; }

            /* Content Area */
            #main-content-area-wrapper {
                height: 100vh;
                overflow-y: auto;
                padding: 30px 40px;
                background: #f8fafc;
                position: relative;
            }

            /* Hide Mobile Elements */
            .bottom-nav, .header-top { display: none !important; }
            
            /* Adjust Banner */
            .main-banner { height: 180px; border-radius: 20px; margin-top: 0; }
            .user-minimal h1 { font-size: 32px; }

            /* Grid Feeds */
            #requests-feed { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
            .glass-card { margin: 0; margin-bottom: 20px; }

            /* Form Grids */
            #page-create .glass-card { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            #page-create .glass-card h3 { grid-column: span 2; }
            #page-create .glass-card textarea { grid-column: span 2; }
            #page-create .glass-card button { grid-column: span 2; }
            #page-create .glass-card #preview-grid { grid-column: span 2; }

            /* Profile Grid */
            #page-profile .glass-card > div { display: grid; grid-template-columns: 200px 1fr; gap: 30px; align-items: start; }
            
            /* Auth Screen Centering */
            #auth-screen { max-width: 500px; margin: 0 auto; height: 100vh; }
            
            /* Support Fab Position */
            .support-fab { left: 30px; bottom: 30px; width: 60px; height: 60px; font-size: 24px; }
        }
    </style>
</head>
<body>

<div class="app-wrapper">
    
    <div class="desktop-sidebar">
        <div class="sidebar-logo">
            <img src="https://a.top4top.io/p_36115ao3o1.jpg">
            <h3 style="margin:0; color:var(--primary);">نظام الصيانة</h3>
            <span style="font-size:11px; color:var(--text-muted);">جامعة الريادة</span>
        </div>
        
        <div class="sidebar-menu">
            <div class="sidebar-item active" onclick="nav('home', this)">
                <i class="fa-solid fa-list-check" style="width:25px;"></i> المهام
            </div>
            <div class="sidebar-item" onclick="nav('team', this)">
                <i class="fa-solid fa-users" style="width:25px;"></i> فريق العمل
            </div>
            <div class="sidebar-item" onclick="nav('create', null)">
                <i class="fa-solid fa-plus-circle" style="width:25px;"></i> بلاغ جديد
            </div>
            <div class="sidebar-item" onclick="nav('profile', this)">
                <i class="fa-solid fa-user" style="width:25px;"></i> حسابي
            </div>
            <div class="sidebar-item" onclick="nav('settings', this)">
                <i class="fa-solid fa-gear" style="width:25px;"></i> الإعدادات
            </div>
        </div>

        <div class="sidebar-user" onclick="document.getElementById('logout-modal').classList.remove('hidden')">
             <i class="fa-solid fa-right-from-bracket" style="color:var(--error);"></i>
             <span style="font-size:12px; font-weight:bold;">تسجيل خروج</span>
        </div>
    </div>
    <audio id="notify-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <a href="mailto:zabdo723@gmail.com" id="support-fab" class="support-fab hidden" style="position:fixed; bottom:90px; left:20px; width:50px; height:50px; background:#25D366; color:#fff; border-radius:50%; display:flex; justify-content:center; align-items:center; z-index:900; box-shadow:0 5px 15px rgba(0,0,0,0.2);"><i class="fa-solid fa-headset"></i></a>

    <div id="loader">
        <i class="fa-solid fa-circle-notch fa-spin fa-3x" style="color:var(--primary);"></i>
        <p style="margin-top:20px; color:white;">جاري التحميل...</p>
    </div>

    <div id="auth-screen" class="hidden">
        <div class="glass-card">
            <img src="https://a.top4top.io/p_36115ao3o1.jpg" style="width:80px; border-radius:15px; margin-bottom:15px;">
            <h2 style="margin:0 0 10px; color:var(--primary);">نظام الصيانة الذكي</h2>
            <div id="reg-fields" class="hidden">
                <p style="text-align:right; font-size:12px; font-weight:bold;">النوع:</p>
                <div class="auth-grid" style="grid-template-columns:1fr 1fr; margin-bottom:10px;">
                    <label><input type="radio" name="auth-gender" value="male" class="auth-card-input" checked><div class="auth-card"><i class="fa-solid fa-person"></i> ذكر</div></label>
                    <label><input type="radio" name="auth-gender" value="female" class="auth-card-input"><div class="auth-card"><i class="fa-solid fa-person-dress"></i> أنثى</div></label>
                </div>
                <div class="input-group"><input type="text" id="reg-name" placeholder="الاسم الكامل"></div>
                <div class="input-group"><input type="tel" id="reg-phone" placeholder="رقم الهاتف"></div>
                <p style="text-align:right; font-size:12px; font-weight:bold;">الوظيفة:</p>
                <div class="auth-grid" style="margin-bottom:10px;">
                    <label><input type="radio" name="auth-role" value="employee" class="auth-card-input" checked><div class="auth-card">موظف</div></label>
                    <label><input type="radio" name="auth-role" value="supervisor" class="auth-card-input"><div class="auth-card">مشرف</div></label>
                    <label><input type="radio" name="auth-role" value="technician" class="auth-card-input"><div class="auth-card">فني</div></label>
                </div>
                <div class="input-group"><input type="text" id="reg-job" placeholder="المسمى الوظيفي"></div>
                <div class="input-group"><input type="text" id="reg-loc" placeholder="مقر العمل"></div>
            </div>
            <div class="input-group"><input type="email" id="email" placeholder="البريد الجامعي"></div>
            <div class="input-group"><input type="password" id="password" placeholder="كلمة المرور"></div>
            <div id="confirm-pass-field" class="hidden input-group"><input type="password" id="confirm-password" placeholder="تأكيد كلمة المرور"></div>
            <button onclick="handleAuth()" id="auth-btn" class="btn-main">تسجيل الدخول</button>
            <p onclick="toggleAuth()" style="font-size:12px; margin-top:15px; cursor:pointer; color:var(--primary);">ليس لديك حساب؟ إنشاء حساب جديد</p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="main-content-area-wrapper">
            <div class="main-banner">
                <div class="header-top">
                    <div class="user-avatar-container" onclick="nav('profile')"><img id="banner-img" src=""></div>
                    <div class="bell-btn" onclick="toast('لا توجد إشعارات')"><i class="fa-regular fa-bell"></i><div class="bell-badge"></div></div>
                </div>
                <div class="user-minimal">
                    <span id="banner-role" class="role-badge">-</span>
                    <h1 id="banner-name">-</h1>
                    <span id="banner-id" style="color:rgba(255,255,255,0.8); font-size:12px;">ID: --</span>
                </div>
            </div>

            <div id="main-content">
                <div id="page-home" class="page-section">
                    <div class="tabs-container">
                        <button class="tab-btn active" onclick="switchTab('active', this)">المهام الجارية</button>
                        <button class="tab-btn" onclick="switchTab('history', this)">الأرشيف</button>
                        <button class="tab-btn" onclick="switchTab('trash', this)" style="color:var(--error);">المحذوفات</button>
                    </div>
                    <div id="filter-container" class="hidden" style="padding:0 15px 10px;">
                        <select id="feed-filter" onchange="renderFeed()"><option value="all">عرض الكل</option><option value="Admin">المبني الاداري</option><option value="Nursing">تمريض</option><option value="CS">حاسبات</option><option value="PT">علاج طبيعي</option><option value="Pharmacy">صيدلة</option><option value="Dentistry">أسنان</option><option value="Business">إدارة أعمال</option></select>
                    </div>
                    <div id="archive-actions" class="hidden" style="padding:0 15px 15px;">
                         <button onclick="downloadArchivePDF()" class="btn-main btn-sm" style="background:var(--success);"><i class="fa-solid fa-file-pdf"></i> تحميل تقرير الأرشيف</button>
                    </div>
                    <div id="requests-feed" style="padding-bottom:100px;"></div>
                </div>

                <div id="page-create" class="page-section hidden">
                    <div class="glass-card">
                        <h3 style="margin:0 0 20px; color:var(--primary);">بلاغ جديد</h3>
                        <div class="input-group"><label>التاريخ</label><input type="date" id="req-date"></div>
                        <div class="input-group"><label>الوقت</label><input type="time" id="req-time"></div>
                        <div class="input-group">
                            <label>نوع العطل</label>
                            <select id="req-type"><option value="">اختر...</option><option value="كهرباء">كهرباء</option><option value="سباكة">سباكة</option><option value="نجارة">نجارة</option><option value="تكييف">تكييف</option><option value="IT">دعم فني (IT)</option></select>
                        </div>
                        <div class="input-group">
                            <label>الأهمية</label>
                            <div style="display:flex; gap:10px;">
                                <label style="flex:1;"><input type="radio" name="prio" value="low" checked hidden><div class="prio-card p-low" style="padding:10px; border:1px solid #ddd; border-radius:10px; text-align:center;">عادي</div></label>
                                <label style="flex:1;"><input type="radio" name="prio" value="medium" hidden><div class="prio-card p-med" style="padding:10px; border:1px solid #ddd; border-radius:10px; text-align:center;">متوسط</div></label>
                                <label style="flex:1;"><input type="radio" name="prio" value="high" hidden><div class="prio-card p-high" style="padding:10px; border:1px solid #ddd; border-radius:10px; text-align:center;">عاجل</div></label>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>الموقع</label>
                            <select id="req-faculty" style="margin-bottom:10px;"><option value="">المبنى...</option><option value="Admin">الاداري</option><option value="Nursing">تمريض</option><option value="CS">حاسبات</option><option value="PT">علاج طبيعي</option><option value="Pharmacy">صيدلة</option><option value="Dentistry">أسنان</option><option value="Business">إدارة أعمال</option><option value="Other">أخرى</option></select>
                            <input type="text" id="req-room" placeholder="رقم الغرفة">
                        </div>
                        <div class="input-group"><label>الوصف</label><textarea id="req-desc" rows="4"></textarea></div>
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <button onclick="document.getElementById('req-files').click()" class="btn-ghost" style="flex:1;"><i class="fa-solid fa-camera"></i> صور/فيديو</button>
                            <input type="file" id="req-files" hidden multiple accept="image/*,video/*" onchange="handleFiles(this)">
                            <button id="mic-trigger" onclick="toggleRecording()" class="btn-ghost" style="width:50px;"><i class="fa-solid fa-microphone"></i></button>
                        </div>
                        <div id="preview-grid" class="media-grid"></div>
                        <button onclick="openSupModal()" class="btn-main" style="margin-top:20px;">التالي</button>
                    </div>
                </div>

                <div id="page-team" class="page-section hidden">
                    <div class="glass-card">
                        <h3>فريق العمل</h3>
                        <div style="display:flex; gap:5px; margin-bottom:15px;">
                            <input type="text" id="search-query" placeholder="بحث ID...">
                            <button onclick="searchUser()" class="btn-main" style="width:auto;"><i class="fa-solid fa-search"></i></button>
                        </div>
                        <div id="search-results" class="hidden"></div>
                        <div id="friend-reqs" class="hidden" style="background:#fff7ed; padding:10px; border-radius:10px; margin-bottom:10px;">
                            <h5>طلبات صداقة:</h5><div id="reqs-list"></div>
                        </div>
                        <h5>الأصدقاء:</h5>
                        <div id="team-list"></div>
                    </div>
                </div>

                <div id="page-profile" class="page-section hidden">
                    <div class="glass-card">
                        <div style="text-align:center;">
                            <img id="edit-current-pic" src="" style="width:120px; height:120px; border-radius:50%; margin-bottom:10px;">
                            <div onclick="document.getElementById('edit-profile-file').click()" style="color:var(--primary); cursor:pointer;">تغيير الصورة</div>
                            <input type="file" id="edit-profile-file" hidden accept="image/*" onchange="previewProfilePic(this)">
                        </div>
                        <div>
                            <div class="input-group"><label>الاسم</label><input type="text" id="edit-name"></div>
                            <div class="input-group"><label>الهاتف</label><input type="tel" id="edit-phone"></div>
                            <div class="input-group"><label>الوظيفة</label><input type="text" id="edit-job"></div>
                            <div class="input-group"><label>الموقع</label><input type="text" id="edit-loc"></div>
                            <button onclick="saveProfile()" id="save-profile-btn" class="btn-main">حفظ</button>
                        </div>
                    </div>
                </div>

                <div id="page-settings" class="page-section hidden">
                    <div class="glass-card">
                        <h3>الإعدادات</h3>
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><span>الإشعارات</span><button onclick="reqNotifyPerm()" class="btn-sm btn-ghost">تفعيل</button></div>
                        <div id="emp-report-btn-container" class="hidden"><button onclick="openEmpReportModal()" class="btn-main">إنشاء تقرير إداري</button></div>
                        <hr style="border-color:var(--border); margin:20px 0;">
                        <button onclick="document.getElementById('logout-modal').classList.remove('hidden')" class="btn-danger btn-main">تسجيل خروج</button>
                    </div>
                </div>

            </div> </div> <div class="bottom-nav">
            <div class="nav-item active" onclick="nav('home', this)"><i class="fa-solid fa-list-check"></i><br>المهام</div>
            <div class="nav-item" onclick="nav('team', this)"><i class="fa-solid fa-users"></i><br>الفريق</div>
            <div class="nav-add-btn" onclick="nav('create', null)"><i class="fa-solid fa-plus"></i></div>
            <div class="nav-item" onclick="nav('profile', this)"><i class="fa-solid fa-user"></i><br>حسابي</div>
            <div class="nav-item" onclick="nav('settings', this)"><i class="fa-solid fa-gear"></i><br>إعدادات</div>
        </div>
    </div>

    <div id="media-viewer" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:9999; display:flex; justify-content:center; align-items:center;">
        <div style="position:absolute; top:20px; right:20px; color:white; cursor:pointer;" onclick="this.parentElement.classList.add('hidden')"><i class="fa-solid fa-xmark fa-2x"></i></div>
        <div id="media-content-container" style="max-width:90%; max-height:80%;"></div>
    </div>

    <div id="sup-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('sup-modal')">x</div>
            <h3>اختر المشرف</h3><div id="sup-list"></div>
            <button onclick="sendRequestFinal()" id="confirm-send-btn" class="btn-main" style="margin-top:15px;">إرسال</button>
        </div>
    </div>

    <div id="request-details-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('request-details-modal')">x</div>
            <h3 style="text-align:center;">تفاصيل البلاغ</h3>
            <div id="req-details-content"></div>
        </div>
    </div>
    
    <div id="tech-report-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('tech-report-modal')">x</div>
            <h3>تقرير فني</h3>
            <input type="text" id="tech-report-title" placeholder="العنوان" style="margin-bottom:10px; width:100%;">
            <textarea id="tech-report-content" rows="5" placeholder="التفاصيل..." style="width:100%;"></textarea>
            <button onclick="submitTechReport()" class="btn-main" style="margin-top:10px;">حفظ PDF</button>
        </div>
    </div>

    <div id="action-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('action-modal')">x</div>
            <h3 id="act-title">إجراء</h3>
            <textarea id="act-comment" rows="3" placeholder="ملاحظات..." style="width:100%;"></textarea>
            <div id="tech-select-area" class="hidden" style="margin-top:10px;">
                <p>اختر الفني:</p><div id="tech-list-action" style="display:grid; grid-template-columns:1fr 1fr; gap:5px;"></div>
            </div>
            <button onclick="submitAction()" id="act-submit-btn" class="btn-main" style="margin-top:10px;">تنفيذ</button>
        </div>
    </div>

    <div id="logout-modal" class="modal-overlay hidden">
        <div class="modal-content" style="text-align:center;">
            <h3>تأكيد الخروج؟</h3>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="logout()" class="btn-danger btn-main">خروج</button>
                <button onclick="closeModal('logout-modal')" class="btn-ghost" style="width:100%;">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="toast" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:10px 20px; border-radius:20px; z-index:99999; display:none;"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyABwJfEkkbNB8GurZkyj67R8ksVNEXZ11I",
        authDomain: "ryadanur1-375a8.firebaseapp.com",
        projectId: "ryadanur1-375a8",
        storageBucket: "ryadanur1-375a8.firebasestorage.app",
        messagingSenderId: "858244114090",
        appId: "1:858244114090:web:42cee8e98e3984164392d3"
    };
    const CLOUD_NAME = "djzfruh22"; 
    const CLOUD_PRESET = "udyvggup";

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser=null, userData=null, isLoginMode=true, selectedSup=null, currentTab='active', requestsCache=[], uploadQueue=[], tempActionData={}, selectedTech=null;
    let isRecording=false, mediaRecorder=null, audioChunks=[];

    auth.onAuthStateChanged(async u => {
        if(u) {
            if(!u.emailVerified) { toast("فعّل البريد أولاً"); auth.signOut(); showScreen('auth-screen'); return; }
            currentUser = u; await loadUser();
        } else {
            document.getElementById('loader').classList.add('hidden'); showScreen('auth-screen');
        }
    });

    async function loadUser() {
        try {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if(doc.exists) {
                userData = doc.data();
                if(!userData.shortId) await db.collection('users').doc(currentUser.uid).update({shortId: Math.random().toString(36).substr(2,6).toUpperCase()});
                renderHeader();
                showScreen('app-container');
                document.getElementById('support-fab').classList.remove('hidden');
                setupRoleUI();
                loadFeed(); loadTeam();
                document.getElementById('loader').classList.add('hidden');
            }
        } catch(e) { toast("خطأ تحميل البيانات"); }
    }

    function setupRoleUI() {
        if(userData.role === 'supervisor') document.getElementById('filter-container').classList.remove('hidden');
        if(userData.role === 'employee') document.getElementById('emp-report-btn-container').classList.remove('hidden');
        if(userData.role === 'technician') {
             // Mobile Nav
             const mBtn = document.querySelector('.bottom-nav .nav-add-btn');
             if(mBtn) { mBtn.innerHTML = '<i class="fa-solid fa-file-pdf"></i>'; mBtn.onclick = () => document.getElementById('tech-report-modal').classList.remove('hidden'); }
             // Desktop Sidebar
             const dBtn = document.querySelectorAll('.sidebar-item')[2];
             if(dBtn) { dBtn.innerHTML = '<i class="fa-solid fa-file-pdf"></i> تقرير فني'; dBtn.onclick = () => document.getElementById('tech-report-modal').classList.remove('hidden'); }
             
             document.getElementById('page-create').innerHTML = "<div style='text-align:center; padding:50px; color:#777;'>حساب فني: للمتابعة والتقارير فقط</div>";
        }
    }

    function renderHeader() {
        const map = {'employee':'موظف', 'supervisor':'مشرف', 'technician':'فني'};
        document.getElementById('banner-name').innerText = userData.fullName;
        document.getElementById('banner-role').innerText = map[userData.role];
        document.getElementById('banner-id').innerText = "ID: " + (userData.shortId || '--');
        const pic = userData.photoUrl || 'https://cdn-icons-png.flaticon.com/512/4140/4140048.png';
        document.getElementById('banner-img').src = pic;
        // Sidebar header sync
        const sideImg = document.querySelector('.sidebar-logo img');
        if(sideImg) sideImg.src = pic;
    }

    function loadFeed() {
        let q = db.collection('requests');
        if(userData.role==='employee') q = q.where('userId','==',currentUser.uid);
        else if(userData.role==='supervisor') q = q.where('supervisorId','==',currentUser.uid);
        else if(userData.role==='technician') q = q.where('technicianId','==',currentUser.uid);

        q.onSnapshot(snap => {
            requestsCache = [];
            snap.forEach(d => requestsCache.push({id:d.id, ...d.data()}));
            requestsCache.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
            renderFeed();
        });
    }

    function renderFeed() {
        const c = document.getElementById('requests-feed'); c.innerHTML = "";
        let list = requestsCache.filter(r => r.isDeleted !== (currentTab !== 'trash'));
        if(currentTab !== 'trash') {
            if(currentTab === 'active') list = list.filter(r => !['done','rejected'].includes(r.status));
            else list = list.filter(r => ['done','rejected'].includes(r.status));
        }
        
        const fac = document.getElementById('feed-filter').value;
        if(userData.role==='supervisor' && fac !== 'all') list = list.filter(r => r.faculty === fac);

        if(list.length === 0) { c.innerHTML = "<div style='text-align:center; padding:20px; color:#888;'>لا يوجد بيانات</div>"; return; }

        list.forEach(d => {
            let stCls = d.status==='pending'?'st-pending':d.status==='done'?'st-done':d.status==='rejected'?'st-rejected':'st-working';
            let date = new Date(d.date + " " + d.time).toLocaleTimeString('ar-EG', {hour:'2-digit',minute:'2-digit'});
            
            // Actions
            let btns = "";
            if(currentTab !== 'trash') {
                if(userData.role==='supervisor' && d.status==='pending') {
                    btns = `<div style="display:flex; gap:5px;"><button onclick="event.stopPropagation(); openAction('${d.id}','approve')" class="btn-sm btn-main" style="background:var(--success)">قبول</button><button onclick="event.stopPropagation(); openAction('${d.id}','reject')" class="btn-sm btn-danger">رفض</button></div>`;
                } else if(userData.role==='technician') {
                    if(d.status==='approved') btns = `<div style="display:flex; gap:5px;"><button onclick="event.stopPropagation(); openAction('${d.id}','startWork')" class="btn-sm btn-main" style="background:var(--warning)">بدء</button><button onclick="event.stopPropagation(); openAction('${d.id}','tech_reject')" class="btn-sm btn-danger">رفض</button></div>`;
                    else if(d.status==='working') btns = `<button onclick="event.stopPropagation(); openAction('${d.id}','done')" class="btn-sm btn-main" style="background:var(--success)">تم</button>`;
                }
                if(userData.role==='employee') btns = `<button onclick="event.stopPropagation(); softDelete('${d.id}')" class="btn-sm btn-ghost" style="color:red;"><i class="fa-solid fa-trash"></i></button>`;
            } else {
                btns = `<button onclick="event.stopPropagation(); restoreReq('${d.id}')" class="btn-sm btn-main">استعادة</button>`;
            }

            c.innerHTML += `
            <div class="glass-card request-card" onclick="openRequestDetails('${d.id}')" style="border-right:4px solid ${d.priority==='high'?'red':d.priority==='medium'?'orange':'green'};">
                <div style="display:flex; justify-content:space-between;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <img src="${d.userData.photoUrl}" style="width:35px; height:35px; border-radius:50%;">
                        <div><b style="font-size:12px;">${d.userData.fullName}</b><br><span style="font-size:10px; color:#888;">${d.date} | ${d.time}</span></div>
                    </div>
                    <span class="status-pill ${stCls}">${d.status}</span>
                </div>
                <p style="font-size:13px; margin:10px 0;">[${d.type}] ${d.description}</p>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                    <span style="font-size:11px; color:#888;">${d.location}</span>
                    ${btns}
                </div>
            </div>`;
        });
    }

    // Actions
    function openAction(id, type) {
        tempActionData = {id, type};
        document.getElementById('action-modal').classList.remove('hidden');
        document.getElementById('act-title').innerText = type==='approve'?'تعيين فني':type==='reject'?'رفض الطلب':'إجراء';
        const tDiv = document.getElementById('tech-select-area');
        tDiv.classList.add('hidden');
        if(type==='approve') {
            tDiv.classList.remove('hidden');
            const l = document.getElementById('tech-list-action'); l.innerHTML="تحميل...";
            db.collection('users').where('role','==','technician').get().then(s => {
                l.innerHTML=""; s.forEach(doc => {
                    const u = doc.data();
                    l.innerHTML += `<div onclick="selectedTech={id:'${doc.id}',name:'${u.fullName}'}; this.style.background='#def'" style="padding:5px; border:1px solid #ddd; border-radius:5px; cursor:pointer; font-size:12px;">${u.fullName}</div>`;
                });
            });
        }
    }

    async function submitAction() {
        const {id, type} = tempActionData;
        const comm = document.getElementById('act-comment').value;
        const d = { supervisorComment: comm };
        if(type==='approve') { if(!selectedTech) return toast("اختر فني"); d.status='approved'; d.technicianId=selectedTech.id; d.technicianName=selectedTech.name; }
        else if(type==='reject') { d.status='rejected'; d.rejectedBy=userData.fullName; }
        else if(type==='startWork') d.status='working';
        else if(type==='tech_reject') { d.status='rejected'; d.rejectedBy="الفني"; }
        else if(type==='done') d.status='done';
        
        await db.collection('requests').doc(id).update(d);
        closeModal('action-modal'); toast("تم التنفيذ");
    }

    // Create Request
    function handleFiles(inp) { Array.from(inp.files).forEach(f => { uploadQueue.push(f); document.getElementById('preview-grid').innerHTML += `<div class="media-item"><img src="${URL.createObjectURL(f)}"></div>`; }); }
    
    async function toggleRecording() {
        if(!isRecording) {
            const s = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRecorder = new MediaRecorder(s); audioChunks=[];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => { uploadQueue.push(new File([new Blob(audioChunks)], "audio.webm", {type:'audio/webm'})); toast("تم التسجيل"); };
            mediaRecorder.start(); isRecording=true; document.getElementById('mic-trigger').style.color='red';
        } else {
            mediaRecorder.stop(); isRecording=false; document.getElementById('mic-trigger').style.color='inherit';
        }
    }

    async function openSupModal() {
        const l = document.getElementById('sup-list'); l.innerHTML = "تحميل...";
        document.getElementById('sup-modal').classList.remove('hidden');
        const s = await db.collection('users').where('role','==','supervisor').get();
        l.innerHTML="";
        s.forEach(doc => {
            const u = doc.data();
            l.innerHTML += `<div onclick="selectedSup='${doc.id}'; this.style.background='#def'" style="padding:10px; border:1px solid #ddd; margin-bottom:5px; border-radius:10px; cursor:pointer;">${u.fullName}</div>`;
        });
    }

    async function sendRequestFinal() {
        if(!selectedSup) return toast("اختر مشرف");
        document.getElementById('confirm-send-btn').innerText = "جاري الإرسال...";
        try {
            let media = [];
            for(const f of uploadQueue) {
                const fd = new FormData(); fd.append('file',f); fd.append('upload_preset', CLOUD_PRESET);
                if(f.type.includes('audio')) fd.append('resource_type','video');
                const r = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method:'POST', body:fd});
                const j = await r.json(); media.push({url:j.secure_url, type: f.type.includes('image')?'image':f.type.includes('audio')?'audio':'video'});
            }
            const fac = document.getElementById('req-faculty').value;
            const loc = fac + " - " + document.getElementById('req-room').value;
            await db.collection('requests').add({
                userId: currentUser.uid, userData: {fullName: userData.fullName, photoUrl: userData.photoUrl},
                supervisorId: selectedSup, status: 'pending',
                type: document.getElementById('req-type').value, priority: 'medium',
                date: document.getElementById('req-date').value, time: document.getElementById('req-time').value,
                description: document.getElementById('req-desc').value, location: loc, faculty: fac, media: media, isDeleted: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            toast("تم الإرسال"); closeModal('sup-modal'); nav('home'); uploadQueue=[];
        } catch(e) { toast("خطأ"); } document.getElementById('confirm-send-btn').innerText="إرسال";
    }

    function openRequestDetails(id) {
        const d = requestsCache.find(r => r.id===id);
        const m = document.getElementById('request-details-modal'); m.classList.remove('hidden');
        let mediaHtml = ""; (d.media||[]).forEach(x => mediaHtml += `<a href="${x.url}" target="_blank" style="display:block; padding:10px; background:#f1f5f9; margin-bottom:5px; border-radius:5px;">ملف مرفق</a>`);
        document.getElementById('req-details-content').innerHTML = `
            <p><strong>الوصف:</strong> ${d.description}</p>
            <p><strong>الموقع:</strong> ${d.location}</p>
            <p><strong>الحالة:</strong> ${d.status}</p>
            <div>${mediaHtml}</div>
            <button onclick="downloadSinglePDF('${d.id}')" class="btn-ghost" style="width:100%; margin-top:10px;">تحميل PDF</button>
        `;
    }

    // Auth
    function toggleAuth() { isLoginMode=!isLoginMode; document.getElementById('reg-fields').classList.toggle('hidden'); document.getElementById('confirm-pass-field').classList.toggle('hidden'); document.getElementById('auth-btn').innerText=isLoginMode?'دخول':'إنشاء'; }
    async function handleAuth() {
        const e=document.getElementById('email').value, p=document.getElementById('password').value, b=document.getElementById('auth-btn');
        b.innerText="...";
        try {
            if(isLoginMode) await auth.signInWithEmailAndPassword(e,p);
            else {
                const c = await auth.createUserWithEmailAndPassword(e,p); await c.user.sendEmailVerification();
                const r = document.querySelector('input[name="auth-role"]:checked').value;
                const g = document.querySelector('input[name="auth-gender"]:checked').value;
                await db.collection('users').doc(c.user.uid).set({
                    email:e, role:r, gender:g, fullName:document.getElementById('reg-name').value, 
                    photoUrl: 'https://cdn-icons-png.flaticon.com/512/4140/4140048.png', shortId: Math.random().toString(36).substr(2,6).toUpperCase(),
                    phone: document.getElementById('reg-phone').value, jobTitle: document.getElementById('reg-job').value, location: document.getElementById('reg-loc').value
                });
                toggleAuth(); toast("تم الإنشاء. تحقق من الإيميل");
            }
        } catch(er) { toast(er.message); } b.innerText=isLoginMode?'دخول':'إنشاء';
    }

    // Reports
    function downloadSinglePDF(id) {
        const r = requestsCache.find(x => x.id === id);
        const e = document.createElement('div'); e.innerHTML = `<h1>تفاصيل البلاغ</h1><p>${r.description}</p><p>${r.location}</p>`;
        html2pdf().from(e).save(`req_${id}.pdf`);
    }

    // Navigation & Utils
    function nav(p, el) { 
        document.querySelectorAll('.page-section').forEach(x=>x.classList.add('hidden'));
        document.getElementById('page-'+p).classList.remove('hidden');
        // Update both Mobile and Desktop Navs
        document.querySelectorAll('.nav-item, .sidebar-item').forEach(x=>x.classList.remove('active'));
        if(el) el.classList.add('active');
        // Special handle for desktop sidebar mapping if el is mobile
        const sideItems = document.querySelectorAll('.sidebar-item');
        if(p==='home') sideItems[0].classList.add('active');
        if(p==='team') sideItems[1].classList.add('active');
        if(p==='create') sideItems[2].classList.add('active');
        if(p==='profile') sideItems[3].classList.add('active');
        if(p==='settings') sideItems[4].classList.add('active');
    }
    
    function showScreen(id) { ['auth-screen','app-container'].forEach(x=>document.getElementById(x).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function switchTab(t, e) { currentTab=t; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); e.classList.add('active'); renderFeed(); }
    function logout() { auth.signOut(); location.reload(); }
    function toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }
    async function softDelete(id) { await db.collection('requests').doc(id).update({isDeleted:true}); toast("نقل للمهملات"); }
    async function restoreReq(id) { await db.collection('requests').doc(id).update({isDeleted:false}); toast("تم الاستعادة"); }

    // Search
    async function searchUser() {
        const q=document.getElementById('search-query').value;
        const d=document.getElementById('search-results'); d.innerHTML="..."; d.classList.remove('hidden');
        const s = await db.collection('users').where('shortId','==',q).get();
        d.innerHTML="";
        if(s.empty) d.innerHTML="لا يوجد";
        s.forEach(doc => { const u=doc.data(); d.innerHTML += `<div style='padding:10px; border:1px solid #ddd;'>${u.fullName} <button onclick="addFriend('${doc.id}','${u.fullName}','${u.photoUrl}')" class='btn-sm btn-main'>إضافة</button></div>`; });
    }
    async function addFriend(id,n,p) { await db.collection('friend_requests').add({fromId:currentUser.uid, toId:id, status:'pending', fromData:{name:userData.fullName,pic:userData.photoUrl}, toData:{name:n,pic:p}}); toast("تم الإرسال"); }
</script>
</body>
</html>
